#!/usr/bin/env bash

set -e
set -u
set -o pipefail

BINDIR=$(dirname "$0")
# shellcheck source=./esyConfig.sh
source "$BINDIR/esyConfig.sh"

buildPath="$1"
buildId=$(basename "$buildPath")

stageDir=$(mktemp -d)
stageBuildPath="$stageDir/$buildId"

outputDir="$PWD/_export"
outputPath="$outputDir/$buildId.tar.gz"

function _do () {
  set -e
  set -u
  set -o pipefail

  local origStorePath
  local destStorePath

  cp -r "$buildPath" "$stageBuildPath"

  origStorePath=$(cat "$stageBuildPath/_esy/storePrefix")
  destStorePath=${origStorePath//?/_}

  esyRewriteStorePrefix "$stageBuildPath" "$origStorePath" "$destStorePath"

  mkdir -p "$outputDir"
  rm -rf "$outputPath"

  (cd "$stageDir" && tar -czf "$outputPath" "$buildId")
}

echo "$buildId: exporting..."

set +e
(_do)
ret="$?"
set -e

rm -rf "$stageBuildPath"

if [ $ret -ne 0 ]; then
  exit 1
fi
echo "$buildId: done"
