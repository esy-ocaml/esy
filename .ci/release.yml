steps:
  - task: DownloadBuildArtifacts@0
    displayName: 'Download Linux Artifacts'
    inputs:
      artifactName: Linux
      downloadPath: '_release'

  - script: 'mkdir _release/platform-linux'
    displayName: 'Create _release/platform-linux'

  - script: 'tar -xzf _release/Linux/*.tgz -C _release/platform-linux'
    displayName: 'untar Linux'

  - task: DownloadBuildArtifacts@0
    displayName: 'Download macOS Artifacts'
    inputs:
      artifactName: macOS
      downloadPath: '_release'

  - script: 'mkdir _release/platform-darwin'
    displayName: 'Create _release/platform-darwin'

  - script: 'tar -xzf _release/macOS/*.tgz -C _release/platform-darwin'
    displayName: 'untar macOS'

  - task: DownloadBuildArtifacts@0
    displayName: 'Download Windows Artifacts'
    inputs:
      artifactName: Windows
      downloadPath: '_release'
    continueOnError: true

  - script: 'mkdir _release/platform-windows-x64'
    displayName: 'Create _release/platform-windows-x64'
    continueOnError: true

  - script: 'tar -xzf _release/Windows/*.tgz -C _release/platform-windows-x64'
    displayName: 'untar Windows'
    continueOnError: true

  - script: 'node scripts/pipelines-release.js'
    displayName: 'node scripts/pipelines-release.js'

  - script: 'npm pack'
    displayName: 'npm pack'
    workingDirectory: '_release'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish packaged release'
    inputs:
      PathtoPublish: '_release/esy-*.tgz'
      ArtifactName: release
